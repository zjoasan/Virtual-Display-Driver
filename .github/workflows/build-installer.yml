name: Build Installer Only

on:
  workflow_dispatch:
    inputs:
      installer_variant:
        description: 'Installer variant to build'
        required: true
        default: 'mixed'
        type: choice
        options:
        - mixed
        - x64-only
        - arm64-only
      version_override:
        description: 'Override version (format: YY.MM.DD)'
        required: false
        type: string
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday morning

env:
  BUILD_CONFIGURATION: Release

permissions:
  contents: read
  actions: write

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Version
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version_override }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = (Get-Date).ToString('yy.MM.dd')
        }
        "INSTALLER_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        Write-Output "Using version: $version"

        $variant = "${{ github.event.inputs.installer_variant }}"
        if ([string]::IsNullOrEmpty($variant)) { $variant = "mixed" }
        "INSTALLER_VARIANT=$variant" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        Write-Output "Building installer variant: $variant"

    - name: Checkout Virtual Driver Installer Repository
      uses: actions/checkout@v4
      with:
        repository: 'VirtualDrivers/Virtual-Driver-Installer'
        path: 'installer-repo'
        token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Build Installer
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        Write-Output "=== Building Virtual Driver Installer ==="
        Write-Output "Variant: $env:INSTALLER_VARIANT"
        Write-Output "Version: $env:INSTALLER_VERSION"

        if (-not (Test-Path "installer-repo")) {
          throw "Installer repository checkout not found (installer-repo)."
        }

        Push-Location installer-repo

        if (-not (Get-Command iscc -ErrorAction SilentlyContinue)) {
          Write-Output "Installing Inno Setup..."
          choco install innosetup -y --no-progress
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        }

        if (Test-Path "Setup.iss") {
          $setupContent = Get-Content "Setup.iss"
          $setupContent = $setupContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$env:INSTALLER_VERSION`""

          switch ($env:INSTALLER_VARIANT) {
            "x64-only" {
              $setupContent = $setupContent -replace 'OutputBaseFilename=.*', "OutputBaseFilename=Virtual-Driver-Control-v$env:INSTALLER_VERSION-setup-x64-only"
            }
            "arm64-only" {
              $setupContent = $setupContent -replace 'OutputBaseFilename=.*', "OutputBaseFilename=Virtual-Driver-Control-v$env:INSTALLER_VERSION-setup-arm64-only"
            }
            default {
              $setupContent = $setupContent -replace 'OutputBaseFilename=.*', "OutputBaseFilename=Virtual-Driver-Control-v$env:INSTALLER_VERSION-setup-mixed-platform"
            }
          }

          $setupContent | Set-Content "Setup.iss"
        } else {
          throw "Setup.iss not found in installer repo."
        }

        if (Test-Path "build-installer.ps1") {
          Write-Output "Running installer preparation script..."
          .\build-installer.ps1
        }

        Write-Output "Compiling installer with Inno Setup..."
        iscc Setup.iss

        if ($LASTEXITCODE -ne 0) { throw "Inno Setup compilation failed." }
        if (-not (Test-Path "output\\*.exe")) { throw "No installer EXE found under output\\." }

        $installerFile = Get-ChildItem "output\\*.exe" | Select-Object -First 1
        Write-Output "âœ… Installer built successfully: $($installerFile.Name)"
        "INSTALLER_NAME=$($installerFile.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        Pop-Location

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: Virtual-Driver-Installer-${{ env.INSTALLER_VERSION }}-${{ env.INSTALLER_VARIANT }}
        path: installer-repo/output/*.exe
        retention-days: 30

